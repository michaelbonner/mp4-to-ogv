<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MP4 to OGV Converter (Batch with Thumbnails)</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f7f7f7;
      }
      #drop-area {
        border: 2px dashed #888;
        border-radius: 8px;
        width: 400px;
        margin: 40px auto;
        padding: 40px;
        text-align: center;
        background: #fff;
        transition: border-color 0.2s;
      }
      #drop-area.dragover {
        border-color: #007bff;
      }
      .download-link {
        display: block;
        margin-top: 10px;
      }
      #progress {
        margin-top: 20px;
      }
      #download-all {
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align: center">
      MP4 to OGV Converter (Batch with Thumbnails)
    </h1>
    <div id="drop-area">
      <p>
        Drag & drop MP4 files here<br />or<br />
        <input type="file" id="fileElem" accept="video/mp4" multiple />
      </p>
      <div id="progress"></div>
      <div id="downloads"></div>
      <button id="download-all">Download All as ZIP</button>
    </div>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      const { createFFmpeg, fetchFile } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true });
      const dropArea = document.getElementById("drop-area");
      const fileElem = document.getElementById("fileElem");
      const progress = document.getElementById("progress");
      const downloads = document.getElementById("downloads");
      const downloadAllBtn = document.getElementById("download-all");

      let ogvFiles = []; // {filename, blob}
      let thumbnailFiles = []; // {filename, blob}

      // Drag & drop handlers
      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("dragover");
      });
      dropArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
      });
      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });
      fileElem.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      async function handleFiles(fileList) {
        if (!fileList.length) return;
        const files = Array.from(fileList).filter(
          (f) => f.type === "video/mp4"
        );
        if (!files.length) {
          progress.textContent = "Please select MP4 files only.";
          return;
        }
        progress.textContent = "Loading FFmpeg...";
        downloads.innerHTML = "";
        ogvFiles = [];
        thumbnailFiles = [];
        downloadAllBtn.style.display = "none";
        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          progress.textContent = `Converting (${i + 1}/${files.length}): ${
            file.name
          }`;
          const inputName = `input${i}.mp4`;
          const outputOgvName = file.name.replace(/\.mp4$/i, ".ogv");
          const baseName = file.name.replace(/\.mp4$/i, "");
          const outputThumbnailName = `${baseName}-thumbnail.jpg`;

          try {
            ffmpeg.FS("writeFile", inputName, await fetchFile(file));
            // Convert to OGV
            await ffmpeg.run(
              "-i",
              inputName,
              "-c:v",
              "libtheora",
              "-c:a",
              "libvorbis",
              outputOgvName
            );
            const ogvData = ffmpeg.FS("readFile", outputOgvName);
            const ogvBlob = new Blob([ogvData.buffer], { type: "video/ogg" });
            const ogvUrl = URL.createObjectURL(ogvBlob);
            const aOgv = document.createElement("a");
            aOgv.href = ogvUrl;
            aOgv.download = outputOgvName;
            aOgv.textContent = `Download ${outputOgvName}`;
            aOgv.className = "download-link";
            downloads.appendChild(aOgv);
            ogvFiles.push({ filename: outputOgvName, blob: ogvBlob });

            // Extract first frame as jpg
            // -ss 0 seeks to the first frame, -frames:v 1 extracts one frame
            await ffmpeg.run(
              "-i",
              inputName,
              "-ss",
              "0",
              "-frames:v",
              "1",
              outputThumbnailName
            );
            const thumbData = ffmpeg.FS("readFile", outputThumbnailName);
            const thumbBlob = new Blob([thumbData.buffer], {
              type: "image/jpeg",
            });
            const thumbUrl = URL.createObjectURL(thumbBlob);
            const aThumb = document.createElement("a");
            aThumb.href = thumbUrl;
            aThumb.download = outputThumbnailName;
            aThumb.textContent = `Download ${outputThumbnailName}`;
            aThumb.className = "download-link";
            downloads.appendChild(aThumb);
            thumbnailFiles.push({
              filename: outputThumbnailName,
              blob: thumbBlob,
            });

            // Clean up FS
            ffmpeg.FS("unlink", inputName);
            ffmpeg.FS("unlink", outputOgvName);
            ffmpeg.FS("unlink", outputThumbnailName);
          } catch (err) {
            const errMsg = document.createElement("div");
            errMsg.textContent = `Failed to convert ${file.name}: ${err.message}`;
            downloads.appendChild(errMsg);
          }
        }
        progress.textContent = "All conversions complete!";
        if (ogvFiles.length > 0 || thumbnailFiles.length > 0) {
          downloadAllBtn.style.display = "inline-block";
        }
      }

      downloadAllBtn.addEventListener("click", async () => {
        if (!ogvFiles.length && !thumbnailFiles.length) return;
        downloadAllBtn.disabled = true;
        downloadAllBtn.textContent = "Zipping...";
        const zip = new JSZip();
        ogvFiles.forEach(({ filename, blob }) => {
          zip.file(filename, blob);
        });
        thumbnailFiles.forEach(({ filename, blob }) => {
          zip.file(filename, blob);
        });
        const content = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(content);
        const a = document.createElement("a");
        a.href = url;
        a.download = "converted_ogv_files_with_thumbnails.zip";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        downloadAllBtn.disabled = false;
        downloadAllBtn.textContent = "Download All as ZIP";
      });
    </script>
  </body>
</html>
